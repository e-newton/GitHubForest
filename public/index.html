<html>

<head>
  <title>Express</title>
  <link rel="stylesheet" href="/stylesheets/style.css">

</head>

<body>
<p id = "json"></p>
  <script src = "three.js"></script>
  <script src = "OrbitControls.js" type = module></script>

  <script type = 'module'>

    class User {
      constructor(calendar, years, currentYear) {
        this.calendar = calendar;
        this.years = years;
        this.weeks = calendar.weeks;
        this.days = [];
        this.currentYear = currentYear;
        this.weeks.forEach(week => {
          week["contributionDays"].forEach(day =>{
            this.days.push(day);
          })
        });

      }
    }

    let currentUser;
    const currentYear = new Date().getFullYear();
    var currentUserName = {name:""};
    var yearField;
    var nameField;
    const data = {user: "e-newton", year: currentYear}
    let options = {
      method: 'POST', // *GET, POST, PUT, DELETE, etc.
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data) // body data type must match "Content-Type" header
    };

    function getCurrentUserData() {
      fetch('/contributions', options).then(res => {
        return res.json();
      }).then(json => {
        const cc = json.data.user["contributionsCollection"];
        currentUser = new User(cc["contributionCalendar"], cc["contributionYears"]);
        console.log(currentUser);
        createForest(currentUser);
        if(!yearField){
          yearField = gui.add(currentUser, 'years', currentUser.years )
          yearField.setValue(currentYear);
          yearField.name("Contribution Years: ");
          yearField.onChange(onYearChange);

        } else{
          console.log("YEARS: " + currentUser.years);
          yearField = yearField.options(currentUser.years);
          yearField.name("Contribution Years: ");
          yearField.onChange(onYearChange);
        }
        if(!nameField){
          nameField = gui.add(currentUserName, 'name');
          nameField.setValue("e-newton");
          nameField.name("Username: ")
          nameField.onFinishChange(onNameChange);
        }




      });
    }

    getCurrentUserData();

    function onYearChange(){
      data.year = yearField.getValue();
      options = {
        method: 'POST', // *GET, POST, PUT, DELETE, etc.
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data) // body data type must match "Content-Type" header
      };
      removeForest();
      getCurrentUserData();

    }

    function onNameChange(){
      data.user = nameField.getValue();
      data.year = new Date().getFullYear();
      yearField.setValue(data.year);
      options = {
        method: 'POST', // *GET, POST, PUT, DELETE, etc.
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data) // body data type must match "Content-Type" header
      };
      removeForest();
      getCurrentUserData();


    }









    import * as THREE from '../build/three.module.js';
    import { OrbitControls } from '/OrbitControls.js';
    import { GUI } from '../build/dat.gui.module.js';
    var smallTree;
    var treeInstances = [];
    var scene = new THREE.Scene();
    var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
    var loader = new THREE.ObjectLoader();
    var renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize( window.innerWidth, window.innerHeight );
    renderer.shadowMap.enabled = true;
    document.body.appendChild( renderer.domElement );

    loader.load("smallTree.json", function ( obj ) {
      console.log(obj)
      smallTree = obj;
    });

    var controls = new OrbitControls( camera, renderer.domElement );
    var directionalLight = new THREE.DirectionalLight( 0xffffff, 1 );
    directionalLight.position.set(5,25,7.5);
    directionalLight.castShadow = true;

    scene.add( directionalLight );
    var group = new THREE.Group();
    group.add(directionalLight);
    scene.add(group);
    camera.position.z = 5;

    var gui = new GUI( { width: 300 } );


    document.addEventListener('keydown', (event) => {
      if(event.code === "Space"){
        removeForest();
      } else if(event.code === "KeyW"){
        console.log("Butts");
        getCurrentUserData();
      }
    })



    controls.update();
    var done = false;
    function animate() {
      requestAnimationFrame( animate );
      if(smallTree !== undefined && !done){
        done = true;
        console.log("DONE")
        console.log(smallTree);
      } else if(!done){
        console.log("NOT DONE")
      }



      renderer.render( scene, camera );
    }
    animate();

    function removeForest(){
      treeInstances.forEach((tree) => {
        scene.remove(tree);
      })
    }

    function createTreeFromDay(weekIndex, dayIndex, dayObject) {
      var tree = createTree(new THREE.Vector3(weekIndex * 2, 0, dayIndex * 2))
      var color = parseInt(dayObject.color.replace("#", "0x"))
      tree.children[1].material.color = new THREE.Color(color);
      tree.scale.set(1,Math.log2(dayObject.contributionCount+1)+0.5,1);
      if (dayObject.contributionCount === 0) {
        tree.remove(tree.children[0]);
      }
      return tree;
    }

    function createForest(user){
      let xDif = 26; //Half of 52 weeks
      let firstWeek = user.weeks[0];
      let lastWeek = user.weeks[user.weeks.length - 1];
      let middleWeeks = user.weeks.splice(1, user.weeks.length-1)
      firstWeek.contributionDays.forEach((value, index) => {
        let i = index - 3;
        var tree = createTreeFromDay(-25,i,value);
        scene.add(tree);
        treeInstances.push(tree);
      });
      middleWeeks.forEach((week, weekIndex) =>{
        let w = weekIndex - 24;
        week.contributionDays.forEach((day, dayIndex) => {
          let i = dayIndex - 3;
          var tree = createTreeFromDay(w, i, day);
          scene.add(tree);
          treeInstances.push(tree);
        })
      })
      lastWeek.contributionDays.forEach((value, index) => {
        let i = index - 3;
        var tree = createTreeFromDay(26,i,value);
        scene.add(tree)
        treeInstances.push(tree);
      });


    }

    function createTree(position){
      let tree = smallTree.clone();
      tree.traverse((node) => {
        if (node.isMesh) {
          node.material = node.material.clone();
        }
      });
      tree.position.set(position.x, position.y, position.z);
      return tree;
    }




  </script>

</body>

</html>
